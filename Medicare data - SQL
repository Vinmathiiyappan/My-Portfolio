#What is the total number of medications prescribed in each state?

SELECT
  nppes_provider_state as PROVIDER_STATE,
  sum(total_claim_count) as TOTAL_MEDICATION
FROM `bigquery-public-data.cms_medicare.part_d_prescriber_2014` 
GROUP BY PROVIDER_STATE
ORDER BY TOTAL_MEDICATION DESC
LIMIT 5 ; 

#What is the most prescribed medication in each state?
 
SELECT
  A.state,
  drug_name,
  total_claim_count,
  day_supply,
  ROUND(total_cost_millions) AS total_cost_millions
FROM (
  SELECT
    generic_name AS drug_name,
    nppes_provider_state AS state,
    ROUND(SUM(total_claim_count)) AS total_claim_count,
    ROUND(SUM(total_day_supply)) AS day_supply,
    ROUND(SUM(total_drug_cost)) / 1e6 AS total_cost_millions
  FROM
    `bigquery-public-data.cms_medicare.part_d_prescriber_2014`
  GROUP BY
    state,
    drug_name) A
INNER JOIN (
  SELECT
    state,
    MAX(total_claim_count) AS max_total_claim_count
  FROM (
    SELECT
      nppes_provider_state AS state,
      ROUND(SUM(total_claim_count)) AS total_claim_count
    FROM
      `bigquery-public-data.cms_medicare.part_d_prescriber_2014`
    GROUP BY
      state,
      generic_name)
    group by state) B
ON
  A.state = B.state
  AND A.total_claim_count = B.max_total_claim_count
ORDER BY
  A.total_claim_count DESC
LIMIT
  5;


#What is the average cost for inpatient and outpatient treatment in each city and state


SELECT
  OP.provider_state AS State,
  ROUND(OP.average_OP_cost) AS Average_OP_Cost,
  ROUND(IP.average_IP_cost) AS Average_IP_Cost,
  
FROM (
  SELECT
    provider_state,
    SUM(average_total_payments*outpatient_services)/SUM(outpatient_services) AS average_OP_cost
  FROM
    `bigquery-public-data.cms_medicare.outpatient_charges_2014`
  GROUP BY
    provider_state ) AS OP
INNER JOIN (
  SELECT
    provider_state,
    SUM(average_medicare_payments*total_discharges)/SUM(total_discharges) AS average_IP_cost
  FROM
    `bigquery-public-data.cms_medicare.inpatient_charges_2014`
  GROUP BY
    provider_state) AS IP
ON
    OP.provider_state = IP.provider_state
ORDER BY
  Average_IP_Cost DESC
LIMIT
  10;

 #Which are the most common inpatient diagnostic conditions in the United States?   

SELECT 
  drg_definition AS DIAGNOSTIC_CONDITION, 
  SUM(total_discharges) AS TOTAL_DISCHARGES
FROM 
  `bigquery-public-data.cms_medicare.inpatient_charges_2014`
GROUP BY
  DIAGNOSTIC_CONDITION
ORDER BY
  TOTAL_DISCHARGES DESC
LIMIT 5;

#Which cities have the most number of cases for each diagnostic condition? 
select distinct(drg_definition) 
FROM 
  `bigquery-public-data.cms_medicare.inpatient_charges_2014` ;
# There 565 distinct diagnostic condition 

WITH ranked_cities AS (
  SELECT 
    provider_state AS STATE,
    provider_city AS CITY, 
    drg_definition AS DIAGNOSTIC_CONDITION, 
    SUM(total_discharges) AS TOTAL_DISCHARGES,
    RANK() OVER (PARTITION BY drg_definition ORDER BY SUM(total_discharges) DESC) AS city_rank
  FROM 
    `bigquery-public-data.cms_medicare.inpatient_charges_2015`
  GROUP BY
    STATE,
    CITY,
    DIAGNOSTIC_CONDITION
)
SELECT 
  STATE,
  CITY,
  DIAGNOSTIC_CONDITION,
  TOTAL_DISCHARGES
FROM 
  ranked_cities
WHERE 
  city_rank = 1
ORDER BY
  TOTAL_DISCHARGES DESC
LIMIT 15;


#prescription drug expenditure 
#Top 10 by total cost 
SELECT 
 generic_name as drug_name, 
 round(sum(total_claim_count)/1e5) as claim_count_lakhs,
 round(sum (total_drug_cost)/1e6) AS total_cost_millions
FROM
`bigquery-public-data.cms_medicare.part_d_prescriber_2014`
group by 
    generic_name 
order by 
    total_cost_millions desc
limit 10 ; 

#Top 10 by claim count
select
  generic_name as drug_name, 
  round(sum(total_claim_count)/1e5) as claim_count_lakhs, 
  round(sum (total_drug_cost)/1e6) AS total_cost_millions
from
`bigquery-public-data.cms_medicare.part_d_prescriber_2014`
group by 
  generic_name 
order by 
  claim_count_lakhs desc
limit 10 ; 













